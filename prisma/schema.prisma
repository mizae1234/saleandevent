generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

// ============ UNIFIED SALES CHANNEL ============
// type = "EVENT" → temporary, has start/end date, supports return flow
// type = "BRANCH" → permanent, no end date, stock remains

model SalesChannel {
  id                    String          @id @default(uuid()) @db.Uuid
  code                  String          @unique @db.VarChar(20)
  type                  String          @default("EVENT") @db.VarChar(10) // EVENT or BRANCH
  name                  String          @db.VarChar(255)
  location              String          @db.VarChar(255)
  startDate             DateTime?       @map("start_date") @db.Date
  endDate               DateTime?       @map("end_date") @db.Date
  salesTarget           Decimal?        @map("sales_target") @db.Decimal(12, 2)
  status                String          @default("draft") @db.VarChar(50)
  responsiblePersonId   String?         @map("responsible_person_id") @db.Uuid
  responsiblePersonName String?         @map("responsible_person_name") @db.VarChar(255)
  phone                 String?         @db.VarChar(50)
  version               Int             @default(1)
  
  // Audit fields
  createdAt             DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime        @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy             String?         @map("created_by") @db.Uuid
  updatedBy             String?         @map("updated_by") @db.Uuid
  
  // Relations
  attendance            Attendance[]
  expenses              ChannelExpense[]
  logs                  ChannelLog[]
  staff                 ChannelStaff[]
  stock                 ChannelStock[]
  returnSummaries       ReturnSummary[]
  sales                 Sale[]
  movements             StockMovement[]
  stockRequests         StockRequest[]

  @@index([type])
  @@index([status])
  @@index([startDate])
  @@index([responsiblePersonId])
  @@map("sales_channels")
}

model ChannelLog {
  id        String       @id @default(uuid()) @db.Uuid
  channelId String       @map("channel_id") @db.Uuid
  action    String       @db.VarChar(50)
  details   Json
  changedBy String       @map("changed_by") @db.Uuid
  changedAt DateTime     @default(now()) @map("changed_at") @db.Timestamptz(6)
  
  channel   SalesChannel @relation(fields: [channelId], references: [id])

  @@index([channelId])
  @@map("channel_logs")
}

// ============ PRODUCTS ============

model Product {
  barcode           String              @id @db.VarChar(50)
  code              String?             @db.VarChar(50)
  name              String              @db.VarChar(255)
  size              String?             @db.VarChar(20)
  price             Decimal?            @default(0) @db.Decimal(10, 2)
  category          String?             @db.VarChar(50)
  producttype       String?             @db.VarChar(250)
  color             String?             @db.VarChar(250)
  status            String              @default("active") @db.VarChar(20)
  
  // Audit fields
  createdAt         DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy         String?             @map("created_by") @db.Uuid
  updatedBy         String?             @map("updated_by") @db.Uuid
  
  // Relations
  allocations       WarehouseAllocation[]
  channelStock      ChannelStock[]
  receivingItems    ReceivingItem[]
  returnItems       ReturnItem[]
  saleItems         SaleItem[]
  stockMovements    StockMovement[]
  warehouseStock    WarehouseStock?

  @@map("products")
}

// ============ INVENTORY ============

model WarehouseStock {
  barcode          String   @id @db.VarChar(50)
  quantity         Int      @default(0)
  reservedQuantity Int      @default(0) @map("reserved_quantity")
  
  // Audit fields
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy        String?  @map("created_by") @db.Uuid
  updatedBy        String?  @map("updated_by") @db.Uuid
  
  // Relations
  product          Product  @relation(fields: [barcode], references: [barcode])

  @@map("warehouse_stock")
}

// Stock per channel — only created after PC confirms receiving
model ChannelStock {
  id               String       @id @default(uuid()) @db.Uuid
  channelId        String       @map("channel_id") @db.Uuid
  barcode          String       @db.VarChar(50)
  quantity         Int          @default(0)
  soldQuantity     Int          @default(0) @map("sold_quantity")
  returnedQuantity Int          @default(0) @map("returned_quantity")
  
  // Audit fields
  createdAt        DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy        String?      @map("created_by") @db.Uuid
  updatedBy        String?      @map("updated_by") @db.Uuid
  
  // Relations
  product          Product      @relation(fields: [barcode], references: [barcode])
  channel          SalesChannel @relation(fields: [channelId], references: [id])

  @@unique([channelId, barcode])
  @@index([channelId])
  @@map("channel_stock")
}

// ============ STOCK MOVEMENT ============

model StockMovement {
  id           String        @id @default(uuid()) @db.Uuid
  movementType String        @map("movement_type") @db.VarChar(50)
  barcode      String        @db.VarChar(50)
  quantity     Int
  fromLocation String?       @map("from_location") @db.VarChar(100)
  toLocation   String?       @map("to_location") @db.VarChar(100)
  channelId    String?       @map("channel_id") @db.Uuid
  referenceId  String?       @map("reference_id") @db.Uuid // stock_request_id or sale_id
  notes        String?
  
  // Audit fields
  createdAt    DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy    String?       @map("created_by") @db.Uuid
  updatedBy    String?       @map("updated_by") @db.Uuid
  
  // Relations
  product      Product       @relation(fields: [barcode], references: [barcode])
  channel      SalesChannel? @relation(fields: [channelId], references: [id])

  @@index([channelId])
  @@index([barcode])
  @@index([createdAt(sort: Desc)])
  @@map("stock_movements")
}

// ============ STOCK REQUESTS ============
// SalesChannel requests a TOTAL QUANTITY only.
// Warehouse decides SKU allocation via Excel upload.
// Status: draft → submitted → approved → allocated → packed → shipped → received | cancelled

model StockRequest {
  id                     String               @id @default(uuid()) @db.Uuid
  channelId              String               @map("channel_id") @db.Uuid
  requestType            String               @default("INITIAL") @map("request_type") @db.VarChar(20) // INITIAL | TOPUP
  requestedTotalQuantity Int                  @map("requested_total_quantity")
  status                 String               @default("draft") @db.VarChar(50)
  notes                  String?
  
  // Approval
  approvedBy             String?              @map("approved_by") @db.Uuid
  approvedAt             DateTime?            @map("approved_at") @db.Timestamptz(6)
  rejectedBy             String?              @map("rejected_by") @db.Uuid
  rejectedAt             DateTime?            @map("rejected_at") @db.Timestamptz(6)
  rejectionReason        String?              @map("rejection_reason")
  
  // Audit fields
  createdAt              DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime             @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy              String?              @map("created_by") @db.Uuid
  updatedBy              String?              @map("updated_by") @db.Uuid
  
  // Relations
  channel                SalesChannel         @relation(fields: [channelId], references: [id])
  allocations            WarehouseAllocation[]
  shipment               Shipment?
  receiving              Receiving?

  @@index([channelId])
  @@index([status])
  @@map("stock_requests")
}

// ============ WAREHOUSE ALLOCATION ============
// Created by warehouse via Excel upload after StockRequest is approved.

model WarehouseAllocation {
  id             String       @id @default(uuid()) @db.Uuid
  stockRequestId String       @map("stock_request_id") @db.Uuid
  barcode        String       @db.VarChar(50)
  size           String?      @db.VarChar(20)
  packedQuantity Int          @map("packed_quantity")
  price          Decimal      @db.Decimal(10, 2)
  
  // Audit fields
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy      String?      @map("created_by") @db.Uuid
  updatedBy      String?      @map("updated_by") @db.Uuid
  
  // Relations
  request        StockRequest @relation(fields: [stockRequestId], references: [id], onDelete: Cascade)
  product        Product      @relation(fields: [barcode], references: [barcode])

  @@index([stockRequestId])
  @@map("warehouse_allocations")
}

// ============ SHIPMENT ============
// One shipment per StockRequest. Created after packing is confirmed.

model Shipment {
  id               String       @id @default(uuid()) @db.Uuid
  stockRequestId   String       @unique @map("stock_request_id") @db.Uuid
  provider         String?      @db.VarChar(100)
  trackingNumber   String?      @map("tracking_number") @db.VarChar(100)
  packedTotalQty   Int          @map("packed_total_quantity")
  shippedAt        DateTime?    @map("shipped_at") @db.Timestamptz(6)
  
  // Audit fields
  createdAt        DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy        String?      @map("created_by") @db.Uuid
  updatedBy        String?      @map("updated_by") @db.Uuid
  
  // Relations
  request          StockRequest @relation(fields: [stockRequestId], references: [id])

  @@map("shipments")
}

// ============ RECEIVING ============
// PC confirms receipt. THIS is when ChannelStock gets created.

model Receiving {
  id               String         @id @default(uuid()) @db.Uuid
  stockRequestId   String         @unique @map("stock_request_id") @db.Uuid
  receivedTotalQty Int            @map("received_total_quantity")
  receivedBy       String?        @map("received_by") @db.Uuid
  receivedAt       DateTime?      @map("received_at") @db.Timestamptz(6)
  notes            String?
  
  // Audit fields
  createdAt        DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy        String?        @map("created_by") @db.Uuid
  updatedBy        String?        @map("updated_by") @db.Uuid
  
  // Relations
  request          StockRequest   @relation(fields: [stockRequestId], references: [id])
  items            ReceivingItem[]

  @@map("receivings")
}

model ReceivingItem {
  id            String    @id @default(uuid()) @db.Uuid
  receivingId   String    @map("receiving_id") @db.Uuid
  barcode       String    @db.VarChar(50)
  allocatedQty  Int       @map("allocated_quantity")
  receivedQty   Int       @map("received_quantity")
  differenceQty Int       @map("difference_quantity")
  remarks       String?
  
  // Audit fields
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy     String?   @map("created_by") @db.Uuid
  updatedBy     String?   @map("updated_by") @db.Uuid
  
  // Relations
  receiving     Receiving @relation(fields: [receivingId], references: [id], onDelete: Cascade)
  product       Product   @relation(fields: [barcode], references: [barcode])

  @@index([receivingId])
  @@map("receiving_items")
}

// ============ SALES & FINANCE ============

model Sale {
  id          String       @id @default(uuid()) @db.Uuid
  billCode    String?      @map("bill_code") @db.VarChar(50)
  channelId   String?      @map("channel_id") @db.Uuid
  staffId     String?      @map("staff_id") @db.Uuid
  totalAmount Decimal      @map("total_amount") @db.Decimal(10, 2)
  discount    Decimal      @default(0) @db.Decimal(10, 2)
  status      String       @default("active") @db.VarChar(20)
  cancelledAt DateTime?    @map("cancelled_at") @db.Timestamptz(6)
  cancelledBy String?      @map("cancelled_by") @db.Uuid
  cancelReason String?     @map("cancel_reason")
  soldAt      DateTime     @default(now()) @map("sold_at") @db.Timestamptz(6)
  
  // Audit fields
  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy   String?      @map("created_by") @db.Uuid
  updatedBy   String?      @map("updated_by") @db.Uuid
  
  // Relations
  items       SaleItem[]
  channel     SalesChannel? @relation(fields: [channelId], references: [id])

  @@index([channelId])
  @@index([soldAt(sort: Desc)])
  @@map("sales")
}

model SaleItem {
  id          String   @id @default(uuid()) @db.Uuid
  saleId      String   @map("sale_id") @db.Uuid
  barcode     String   @db.VarChar(50)
  quantity    Int
  unitPrice   Decimal  @map("unit_price") @db.Decimal(10, 2)
  totalAmount Decimal  @map("total_amount") @db.Decimal(10, 2)
  isFreebie   Boolean  @default(false) @map("is_freebie")
  
  // Audit fields
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy   String?  @map("created_by") @db.Uuid
  updatedBy   String?  @map("updated_by") @db.Uuid
  
  // Relations
  product     Product  @relation(fields: [barcode], references: [barcode])
  sale        Sale     @relation(fields: [saleId], references: [id])

  @@map("sale_items")
}

model ChannelExpense {
  id          String       @id @default(uuid()) @db.Uuid
  channelId   String       @map("channel_id") @db.Uuid
  category    String       @db.VarChar(50)
  amount      Decimal      @db.Decimal(10, 2)
  description String?
  receiptUrl  String?      @map("receipt_url")
  status      String       @default("draft") @db.VarChar(50)
  
  // Audit fields
  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy   String?      @map("created_by") @db.Uuid
  updatedBy   String?      @map("updated_by") @db.Uuid
  
  // Relations
  channel     SalesChannel @relation(fields: [channelId], references: [id])

  @@index([channelId])
  @@index([status])
  @@map("channel_expenses")
}

// ============ HR & PAYROLL ============

model Staff {
  id               String         @id @default(uuid()) @db.Uuid
  name             String         @db.VarChar(255)
  role             String         @default("PC") @db.VarChar(50)
  phone            String?        @db.VarChar(50)
  paymentType      String         @default("daily") @map("payment_type") @db.VarChar(50)
  dailyRate        Decimal?       @map("daily_rate") @db.Decimal(10, 2)
  commissionAmount Decimal?       @map("commission_amount") @db.Decimal(10, 2)
  status           String         @default("active") @db.VarChar(20)
  
  // Audit fields
  createdAt        DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy        String?        @map("created_by") @db.Uuid
  updatedBy        String?        @map("updated_by") @db.Uuid
  
  // Relations
  attendance       Attendance[]
  assignments      ChannelStaff[]

  @@index([status])
  @@map("staff")
}

model ChannelStaff {
  id                 String       @id @default(uuid()) @db.Uuid
  channelId          String       @map("channel_id") @db.Uuid
  staffId            String       @map("staff_id") @db.Uuid
  assignedAt         DateTime     @default(now()) @map("assigned_at") @db.Timestamptz(6)
  commissionOverride Decimal?     @map("commission_override") @db.Decimal(10, 2)
  role               String?      @default("PC")
  isMain             Boolean      @default(false) @map("is_main")
  
  // Audit fields
  createdAt          DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy          String?      @map("created_by") @db.Uuid
  updatedBy          String?      @map("updated_by") @db.Uuid
  
  // Relations
  channel            SalesChannel @relation(fields: [channelId], references: [id])
  staff              Staff        @relation(fields: [staffId], references: [id])

  @@unique([channelId, staffId])
  @@index([channelId])
  @@index([staffId])
  @@map("channel_staff")
}

model Attendance {
  id          String       @id @default(uuid()) @db.Uuid
  channelId   String       @map("channel_id") @db.Uuid
  staffId     String       @map("staff_id") @db.Uuid
  date        DateTime     @db.Date
  hoursWorked Decimal      @default(8) @map("hours_worked") @db.Decimal(4, 2)
  notes       String?
  
  // Audit fields
  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy   String?      @map("created_by") @db.Uuid
  updatedBy   String?      @map("updated_by") @db.Uuid
  
  // Relations
  channel     SalesChannel @relation(fields: [channelId], references: [id])
  staff       Staff        @relation(fields: [staffId], references: [id])

  @@unique([channelId, staffId, date])
  @@index([channelId])
  @@map("attendance")
}

// ============ RETURNS (EVENT only) ============

model ReturnSummary {
  id          String       @id @default(uuid()) @db.Uuid
  channelId   String       @map("channel_id") @db.Uuid
  submittedAt DateTime     @default(now()) @map("submitted_at") @db.Timestamptz(6)
  confirmedAt DateTime?    @map("confirmed_at") @db.Timestamptz(6)
  confirmedBy String?      @map("confirmed_by") @db.VarChar(100)
  
  // Audit fields
  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy   String?      @map("created_by") @db.Uuid
  updatedBy   String?      @map("updated_by") @db.Uuid
  
  // Relations
  items       ReturnItem[]
  channel     SalesChannel @relation(fields: [channelId], references: [id])

  @@map("return_summaries")
}

model ReturnItem {
  id                String        @id @default(uuid()) @db.Uuid
  returnSummaryId   String        @map("return_summary_id") @db.Uuid
  barcode           String        @db.VarChar(50)
  soldQuantity      Int           @default(0) @map("sold_quantity")
  remainingQuantity Int           @default(0) @map("remaining_quantity")
  damagedQuantity   Int           @default(0) @map("damaged_quantity")
  missingQuantity   Int           @default(0) @map("missing_quantity")
  
  // Audit fields
  createdAt         DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy         String?       @map("created_by") @db.Uuid
  updatedBy         String?       @map("updated_by") @db.Uuid
  
  // Relations
  product           Product       @relation(fields: [barcode], references: [barcode])
  returnSummary     ReturnSummary @relation(fields: [returnSummaryId], references: [id], onDelete: Cascade)

  @@map("return_items")
}

// ============ PROMOTIONS ============

model Promotion {
  id          String    @id @default(uuid()) @db.Uuid
  code        String    @unique @db.VarChar(50)
  name        String    @db.VarChar(255)
  description String?
  type        String    @db.VarChar(50)
  startDate   DateTime  @map("start_date") @db.Date
  endDate     DateTime? @map("end_date") @db.Date
  isActive    Boolean   @default(true) @map("is_active")
  config      Json
  
  // Audit fields
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy   String?   @map("created_by") @db.Uuid
  updatedBy   String?   @map("updated_by") @db.Uuid

  @@map("promotions")
}

// ============ USER MANAGEMENT ============

model User {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique
  passwordHash String?  @map("password_hash")
  name         String   @map("full_name")
  role         String
  status       String   @default("active")
  
  // Audit fields
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy    String?  @map("created_by") @db.Uuid
  updatedBy    String?  @map("updated_by") @db.Uuid

  @@map("users")
}
